<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TickTick MCP — Setup</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: #0f172a; color: #e2e8f0;
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    padding: 1rem;
  }
  .card {
    background: #1e293b; border-radius: 12px; padding: 2rem;
    max-width: 580px; width: 100%; box-shadow: 0 4px 24px rgba(0,0,0,.4);
  }
  h1 { font-size: 1.5rem; margin-bottom: .25rem; }
  .subtitle { color: #94a3b8; margin-bottom: 1.5rem; font-size: .9rem; }
  label { display: block; font-size: .85rem; color: #94a3b8; margin-bottom: .3rem; margin-top: 1rem; }
  input:not([type="checkbox"]) {
    width: 100%; padding: .6rem .75rem; border: 1px solid #334155; border-radius: 6px;
    background: #0f172a; color: #e2e8f0; font-size: .95rem; outline: none;
  }
  input:not([type="checkbox"]):focus { border-color: #3b82f6; }
  .btn {
    display: inline-block; margin-top: 1rem; padding: .65rem 1.5rem;
    background: #3b82f6; color: #fff; border: none; border-radius: 6px;
    font-size: .95rem; cursor: pointer; font-weight: 500; width: 100%; text-align: center;
  }
  .btn:hover { background: #2563eb; }
  .btn-copy { background: #059669; }
  .btn-copy:hover { background: #047857; }
  .btn-outline {
    background: transparent; border: 1px solid #475569; color: #94a3b8;
  }
  .btn-outline:hover { background: #1e293b; border-color: #64748b; color: #e2e8f0; }
  .btn-secondary { background: #475569; margin-top: .5rem; }
  .btn-secondary:hover { background: #3f4f63; }
  pre {
    background: #0f172a; border: 1px solid #334155; border-radius: 6px;
    padding: 1rem; overflow-x: auto; font-size: .82rem; line-height: 1.5;
    white-space: pre; color: #a5f3fc; margin-top: 1rem; max-height: 420px; overflow-y: auto;
  }
  .step { color: #94a3b8; font-size: .85rem; margin-bottom: .5rem; }
  .step a { color: #60a5fa; text-decoration: none; }
  .step a:hover { text-decoration: underline; }
  .error { color: #f87171; margin-top: 1rem; font-size: .9rem; }
  .success { color: #34d399; }
  .note { color: #94a3b8; font-size: .8rem; margin-top: 1rem; line-height: 1.4; }
  .hidden { display: none; }
  .copied { background: #047857; border-color: #047857; color: #fff; }
  .toggle-row {
    display: flex; align-items: center; gap: .5rem; margin-top: 1rem;
    font-size: .85rem; color: #cbd5e1; cursor: pointer; user-select: none;
  }
  .toggle-row input[type="checkbox"] {
    width: 16px; height: 16px; accent-color: #3b82f6; cursor: pointer;
  }
  .toggle-hint { color: #64748b; font-size: .75rem; margin-top: .2rem; margin-left: 1.6rem; }
  .divider {
    border: none; border-top: 1px solid #334155; margin: 1.5rem 0 .5rem;
  }
  .gh-link {
    display: inline-flex; align-items: center; gap: .4rem;
    color: #94a3b8; font-size: .8rem; text-decoration: none; margin-top: 1.2rem;
  }
  .gh-link:hover { color: #e2e8f0; }
  .gh-link svg { width: 16px; height: 16px; fill: currentColor; }
</style>
</head>
<body>

<div class="card">
  <!-- Main view: template + auth button -->
  <div id="mainView">
    <h1>TickTick MCP</h1>
    <p class="subtitle">Manage TickTick tasks from Claude, MetaMCP, or any MCP client. Generate a config, paste it — ready to go.</p>

    <!-- Auth section -->
    <div id="authSection">
      <p class="step" style="margin-top:.5rem">The config below has placeholder values. Authorize to replace them with your real credentials and tokens.</p>
      <button class="btn" onclick="showAuthForm()">Get started</button>
    </div>

    <!-- Auth form (hidden until button clicked) -->
    <div id="authForm" class="hidden">
      <p class="step" style="margin-bottom:.75rem">First, you need a TickTick app. It takes 30 seconds:</p>
      <p class="step">1. Open <a href="https://developer.ticktick.com" target="_blank" rel="noopener">developer.ticktick.com</a> → <strong>Manage Apps</strong> → <strong>+App Name</strong></p>
      <p class="step">2. Set <strong>Redirect URI</strong> to: <code style="color:#a5f3fc">https://nikitatsym.github.io/ticktick-mcp/</code></p>
      <p class="step">3. Copy <strong>Client ID</strong> and <strong>Client Secret</strong> and paste below:</p>

      <label for="clientId">Client ID</label>
      <input id="clientId" type="text" placeholder="Paste your Client ID" autocomplete="off">

      <label for="clientSecret">Client Secret</label>
      <input id="clientSecret" type="password" placeholder="Paste your Client Secret" autocomplete="off">

      <div id="formError" class="error hidden"></div>

      <button class="btn" onclick="startAuth()">Authorize with TickTick</button>

      <p class="note">Your credentials stay in your browser. Nothing is sent anywhere except TickTick.</p>
    </div>

    <hr class="divider">

    <pre id="configJson"></pre>

    <button class="btn btn-outline" id="copyBtn" onclick="copyConfig()">Copy to clipboard</button>

    <p class="note hidden" id="codeNote"></p>

    <a class="gh-link" href="https://github.com/nikitatsym/ticktick-mcp" target="_blank" rel="noopener">
      <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      GitHub
    </a>
  </div>

  <!-- Error state -->
  <div id="errorView" class="hidden">
    <h1 style="color:#f87171">Authorization failed</h1>
    <p id="errorMsg" class="error"></p>
    <button class="btn" style="margin-top:1rem" onclick="reset()">Try again</button>
  </div>
</div>

<script>
const TICKTICK_AUTH_URL = 'https://ticktick.com/oauth/authorize';
const TICKTICK_TOKEN_URL = 'https://ticktick.com/oauth/token';
const REDIRECT_URI = 'https://nikitatsym.github.io/ticktick-mcp/';
const SCOPES = 'tasks:read tasks:write';
const LS_KEY = 'ticktick_mcp_auth';

// Current env — null means template mode, object means real data
window._configEnv = null;

const INDEX_URL = 'https://nikitatsym.github.io/ticktick-mcp/simple';

function refreshConfig() {
  const env = window._configEnv || {
    TICKTICK_CLIENT_ID: 'YOUR_CLIENT_ID',
    TICKTICK_CLIENT_SECRET: 'YOUR_CLIENT_SECRET',
    TICKTICK_ACCESS_TOKEN: 'YOUR_ACCESS_TOKEN',
  };

  const config = {
    mcpServers: {
      ticktick: {
        command: 'uvx',
        args: ['--index-url', INDEX_URL, 'ticktick-mcp'],
        env: env,
      },
    },
  };

  document.getElementById('configJson').textContent = JSON.stringify(config, null, 2);
}

function showAuthForm() {
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('authForm').classList.remove('hidden');
}

function startAuth() {
  const clientId = document.getElementById('clientId').value.trim();
  const clientSecret = document.getElementById('clientSecret').value.trim();
  const errEl = document.getElementById('formError');

  if (!clientId || !clientSecret) {
    errEl.textContent = 'Both Client ID and Client Secret are required.';
    errEl.classList.remove('hidden');
    return;
  }

  localStorage.setItem(LS_KEY, JSON.stringify({ clientId, clientSecret }));

  const state = Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem(LS_KEY + '_state', state);

  const params = new URLSearchParams({
    client_id: clientId,
    redirect_uri: REDIRECT_URI,
    response_type: 'code',
    scope: SCOPES,
    state: state,
  });

  window.location.href = TICKTICK_AUTH_URL + '?' + params.toString();
}

async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const state = params.get('state');
  const error = params.get('error');

  if (error) {
    showError('TickTick returned an error: ' + (params.get('error_description') || error));
    return;
  }

  if (!code) return; // Not a callback — show template

  const savedState = localStorage.getItem(LS_KEY + '_state');
  if (savedState && state !== savedState) {
    showError('State mismatch — possible CSRF attack. Please try again.');
    return;
  }

  const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
  if (!saved || !saved.clientId || !saved.clientSecret) {
    showError('Client credentials not found. This can happen if you cleared your browser data. Please start over.');
    return;
  }

  const { clientId, clientSecret } = saved;

  window.history.replaceState({}, document.title, window.location.pathname);

  let tokens = null;
  try {
    tokens = await exchangeCode(code, clientId, clientSecret);
  } catch (e) {
    console.warn('Token exchange failed (likely CORS):', e.message);
  }

  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_KEY + '_state');

  const env = {
    TICKTICK_CLIENT_ID: clientId,
    TICKTICK_CLIENT_SECRET: clientSecret,
  };

  if (tokens) {
    env.TICKTICK_ACCESS_TOKEN = tokens.access_token;
    if (tokens.refresh_token) {
      env.TICKTICK_REFRESH_TOKEN = tokens.refresh_token;
    }
  } else {
    env.TICKTICK_AUTH_CODE = code;
  }

  window._configEnv = env;

  // Hide auth section — show success note instead
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('authForm').classList.add('hidden');

  // Update subtitle
  document.querySelector('.subtitle').textContent = 'Copy the config below and paste it into your MCP client. That\'s it!';
  document.querySelector('h1').classList.add('success');
  document.querySelector('h1').textContent = 'Ready!';

  // Promote copy button after successful auth
  const copyBtn = document.getElementById('copyBtn');
  copyBtn.classList.remove('btn-outline');
  copyBtn.classList.add('btn-copy');

  refreshConfig();

  const noteEl = document.getElementById('codeNote');
  if (!tokens) {
    noteEl.textContent = 'Note: The auth code (TICKTICK_AUTH_CODE) will be automatically exchanged for tokens on first server start. The code is single-use and expires in a few minutes — paste the config promptly.';
    noteEl.classList.remove('hidden');
  }

  // Add "start over" button
  const divider = document.querySelector('.divider');
  divider.classList.remove('hidden');
  divider.insertAdjacentHTML('afterend',
    '<button class="btn btn-secondary" onclick="reset()">Start over</button>');
}

async function exchangeCode(code, clientId, clientSecret) {
  const basicAuth = btoa(clientId + ':' + clientSecret);

  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: REDIRECT_URI,
    scope: SCOPES,
  });

  const res = await fetch(TICKTICK_TOKEN_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Authorization': 'Basic ' + basicAuth,
    },
    body: body.toString(),
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error('Token exchange failed (' + res.status + '): ' + text);
  }

  return res.json();
}

function copyConfig() {
  const text = document.getElementById('configJson').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'Copy to clipboard';
      btn.classList.remove('copied');
    }, 2000);
  });
}

function showError(msg) {
  document.getElementById('mainView').classList.add('hidden');
  document.getElementById('errorView').classList.remove('hidden');
  document.getElementById('errorMsg').textContent = msg;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_KEY + '_state');
}

function reset() {
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_KEY + '_state');
  window.location.href = window.location.pathname;
}

// Init
refreshConfig();
handleCallback();
</script>

</body>
</html>
